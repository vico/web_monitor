{% extends "base.html" %}
{% import "bootstrap/wtf.html" as wtf %}

{% block title %}Trade history - Index{% endblock %}

{% block page_content %}
<div class="page-header">
    <h2 style="display:inline-block;">{{params['name']}} ({{params['quick']}})</h2> 
     <form class="form-inline" style="display:inline-block;float:right;" method="GET" action="check">
        <div class="form-group">
            <label for="quick">Quick</label>
            <input type="text" class="form-control" size="10" id="quick" name="quick" placeholder="7200 or 711 HK or HACK US" autofocus required>
        </div>
        <div class="form-group"> 
            <label for="datepicker1">Start</label>
            <input type="text" class="form-control" size="7" value=""  name="start" id="datepicker1">
        </div>
        <div class="form-group"> 
            <label for="datepicker2">End</label>
            <input type="text" class="form-control" size="7" value="" name="end" id="datepicker2">
        </div>
        <button type="submit" class="btn btn-default">Go</button>
    </form>
</div>
<div class="col-md-12">
    <div class="col-md-6">
        <table class="table">
            <thead>
                <tr>
                    <th></th><th></th><th>Trade</th><th>PL</th><th>Outperf.</th><th>Alpha</th><th>Win%</th>
                    <th>OP%</th><th>Al.%</th>
                </tr>
            </thead>
            <tbody>
                {% for fund in ['RH','YA','LR'] %}

                {% if alpha[fund] is defined and op_hit[fund] is defined %}
                {% if tbldata[fund+'Attr']['long_count'] > 0 %}
                <tr>
                    <td>{{fund}}</td>
                    <td>L</td>
                    <td>{{tbldata[fund+'Attr']['long_count']}}</td>
                    <td>{{'{:.2f}%'.format(pl[(fund+'Attr', 'L')])}}</td>
                    <td>{{'{:.2f}%'.format( rhop['L'] if fund == 'RH' else (yaop['L'] if fund=='YA' else (lrop['L'] if fund == 'LR' else 0)))}}</td>
                    <td>{{'{:.2f}%'.format(rhalpha['L'] if fund == 'RH' else (yaalpha['L'] if fund == 'YA' else (lralpha['L'] if fund == 'LR' else 0)))}}</td>
                    <td>{{'{:.0f}%'.format(tbldata[fund+'Attr']['long_ratio']*100)}}</td>
                    <td>{{'{:.0f}%'.format(op_hit[fund]['long_ratio']*100)}}</td>
                    <td>{{'{:.0f}%'.format(alpha[fund]['long_ratio']*100)}}</td>
                </tr>
                {% endif %}

                {% if tbldata[fund+'Attr']['short_count'] > 0 %}
                <tr>
                    <td>{{ '' if tbldata[fund + 'Attr'].long_count > 0 else fund }}</td>
                    <td>S</td>
                    <td>{{tbldata[fund+'Attr']['short_count']}}</td>
                    <td>{{'{:.2f}%'.format(pl[(fund+'Attr', 'S')])}}</td>
                    <td>{{'{:.2f}%'.format(rhop['S'] if fund=='RH' else (yaop['S'] if fund == 'YA' else (lrop['S'] if fund == 'LR' else 0)))}}</td>
                    <td>{{'{:.2f}%'.format(rhalpha['S'] if fund == 'RH' else (yaalpha['S'] if fund == 'YA' else (lralpha['S'] if fund == 'LR' else 0)))}}</td>
                    <td>{{'{:.0f}%'.format(tbldata[fund + 'Attr']['short_ratio']*100)}}</td>
                    <td>{{'{:.0f}%'.format(op_hit[fund]['short_ratio']*100)}}</td>
                    <td>{{'{:.0f}%'.format(alpha[fund]['short_ratio']*100)}}</td>
                </tr>
                {% endif %}

                {% if tbldata[fund+'Attr']['long_count'] > 0 or tbldata[fund+'Attr']['short_count'] > 0 %}
                <tr>
                    <td></td>
                    <td>Total</td>
                    <td>{{(tbldata[fund+'Attr']['long_count'] if tbldata[fund+'Attr']['long_count'] > 0 else 0) + (tbldata[fund+'Attr']['short_count'] if tbldata[fund+'Attr']['short_count'] > 0 else 0 )}}</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td>{{'{:.0f}%'.format(tbldata[fund+'Attr']['total_ratio']*100)}}</td>
                    <td>{{'{:.0f}%'.format(op_hit[fund]['total_ratio']*100)}}</td>
                    <td>{{'{:.0f}%'.format(alpha[fund]['total_ratio']*100)}}</td>
                </tr>
                {% endif %}
                {% endif %}
            {% endfor %}

            </tbody>
        </table>

    </div>

    <div class="col-md-6">
        {{ params['table'] | safe }}
    </div>
</div>

<div class="col-md-12">
        {% if tbldata['RHAttr']['long_count'] > 0 or tbldata['RHAttr']['short_count'] > 0 %}
       <h4>Rockhampton Position Size Chart</h4>
       <div id="rh_position_graph"></div> 
       {% endif %}

       {% if tbldata['YAAttr']['long_count'] > 0 or tbldata['YAAttr']['short_count'] > 0 %}
       <h4>Yaraka Position Size Chart</h4>
       <div id="ya_position_graph"></div> 
       {% endif %}

       {% if tbldata['LRAttr']['long_count'] > 0 or tbldata['LRAttr']['short_count'] > 0 %}
       <h4>Longreach Position Size Chart</h4>
       <div id="lr_position_graph"></div> 
       {% endif %}

       {% if tbldata['RHAttr']['long_count'] > 0 or tbldata['RHAttr']['short_count'] > 0 %}
       <h4>RH Trade Charts</h4>
       <div id="rh_price_graph"></div>
       <div id="rh_rate_graph"></div>
       {% endif %}

       {% if tbldata['RHAttr']['long_count'] == 0 and tbldata['RHAttr']['short_count'] == 0 and (tbldata['YAAttr']['long_count'] > 0 or tbldata['YAAttr']['short_count'] > 0) %}
       <h4>YA Trade Charts</h4>
       <div id="ya_price_graph"></div>
       <div id="ya_rate_graph"></div>
       {% endif %}
       
       {% if tbldata['RHAttr']['long_count'] == 0 and tbldata['RHAttr']['short_count'] == 0 and tbldata['YAAttr']['long_count'] == 0 and tbldata['YAAttr']['short_count'] == 0 and (tbldata['LRAttr']['long_count'] > 0 or tbldata['LRAttr']['short_count'] > 0) %}
       <h4>LR Trade Charts</h4>
       <div id="lr_price_graph"></div>
       <div id="lr_rate_graph"></div>
       {% endif %}
</div>
<script src="{{ url_for('static', filename='jquery-2.2.0.min.js') }}"></script>


<!-- wiki display modal -->
<div class="modal fade" id="wikimodal" role="dialog" aria-labelledby="modalTitle">
   <div class="modal-dialog" role="document">
       <div class="modal-content">
            <div class="modal-header">  
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="myModalLabel">Wiki Comment</h4>
          </div>
          <div class="modal-body">
            ...
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
       </div>
   </div>
</div>



{% if tbldata['RHAttr']['long_count'] > 0 or tbldata['RHAttr']['short_count'] > 0 %}
  <script>
     long_plot = function() {
        rh_price_graph = document.getElementById("rh_price_graph");
        rh_rate_graph = document.getElementById('rh_rate_graph');

        Plotly.plot( rh_price_graph, {{params['rh_price_graph'].data | safe }}, {{ params['rh_price_graph'].layout | safe }});
        Plotly.plot( rh_rate_graph, {{params['rh_rate_graph'].data | safe }}, {{ params['rh_rate_graph'].layout | safe }});
     };

    if (document.readyState === 'complete' || document.readyState !== 'loading') {
        long_plot();
     } else {
        document.addEventListener('DOMContentLoaded', long_plot);
      }
  </script>
{% endif %}

{% if tbldata['RHAttr']['long_count'] == 0 and tbldata['RHAttr']['short_count'] == 0 and (tbldata['YAAttr']['long_count'] > 0 or tbldata['YAAttr']['short_count'] > 0) %}
    <script>
     ya_graph_plot = function() {
        ya_price_graph = document.getElementById("ya_price_graph");
        ya_rate_graph = document.getElementById('ya_rate_graph');

        Plotly.plot( ya_price_graph, {{params['ya_price_graph'].data | safe }}, {{ params['ya_price_graph'].layout | safe }});
        Plotly.plot( ya_rate_graph, {{params['ya_rate_graph'].data | safe }}, {{ params['ya_rate_graph'].layout | safe }});
     };

    if (document.readyState === 'complete' || document.readyState !== 'loading') {
        ya_graph_plot();
     } else {
        document.addEventListener('DOMContentLoaded', ya_graph_plot);
      }
  </script>

{% endif %}

{% if tbldata['RHAttr']['long_count'] == 0 and tbldata['RHAttr']['short_count'] == 0 and tbldata['YAAttr']['long_count'] == 0 and tbldata['YAAttr']['short_count'] == 0 and (tbldata['LRAttr']['long_count'] > 0 or tbldata['LRAttr']['short_count'] > 0) %}
    <script>
     lr_graph_plot = function() {
        lr_price_graph = document.getElementById("lr_price_graph");
        lr_rate_graph = document.getElementById('lr_rate_graph');

        Plotly.plot( lr_price_graph, {{params['lr_price_graph'].data | safe }}, {{ params['lr_price_graph'].layout | safe }});
        Plotly.plot( lr_rate_graph,  {{params['lr_rate_graph'].data | safe }},  {{ params['lr_rate_graph'].layout | safe }});
     };

    if (document.readyState === 'complete' || document.readyState !== 'loading') {
        lr_graph_plot();
     } else {
        document.addEventListener('DOMContentLoaded', lr_graph_plot);
      }
  </script>

{% endif %}

{% if tbldata['RHAttr']['long_count'] > 0 or tbldata['RHAttr']['short_count'] > 0 %}
<script>
    position_plot = function() {
        rh_position_graph = document.getElementById("rh_position_graph");
        Plotly.plot( rh_position_graph , {{params['rh_position_graph'].data | safe }}, {{ params['rh_position_graph'].layout | safe }});
    };
    if (document.readyState === 'complete' || document.readyState !== 'loading') {
        position_plot();
    } else {
        document.addEventListener('DOMContentLoaded', position_plot);
    }
</script>
{% endif %}

{% if tbldata['YAAttr']['long_count'] > 0 or tbldata['YAAttr']['short_count'] > 0 %}
<script>
    ya_position_plot = function() {
        ya_position_graph = document.getElementById("ya_position_graph");
        Plotly.plot( ya_position_graph , {{params['ya_position_graph'].data | safe }}, {{ params['ya_position_graph'].layout | safe }});
    };
    if (document.readyState === 'complete' || document.readyState !== 'loading') {
        ya_position_plot();
    } else {
        document.addEventListener('DOMContentLoaded', ya_position_plot);
    }
</script>
{% endif %}

{% if tbldata['LRAttr']['long_count'] > 0 or tbldata['LRAttr']['short_count'] > 0 %}
<script>
    lr_position_plot = function() {
        lr_position_graph = document.getElementById("lr_position_graph");
        Plotly.plot( lr_position_graph , {{params['lr_position_graph'].data | safe }}, {{ params['lr_position_graph'].layout | safe }});
    };
    if (document.readyState === 'complete' || document.readyState !== 'loading') {
        lr_position_plot();
    } else {
        document.addEventListener('DOMContentLoaded', lr_position_plot);
    }
</script>
{% endif %}

<script>
    init_func = function() {
        var picker1 = new Pikaday({
                field: document.getElementById('datepicker1'),
                format: 'YYYY-MM-DD'
         });
        var picker2 = new Pikaday({
                field: document.getElementById('datepicker2'),
                format: 'YYYY-MM-DD'
         });
    }
    if (document.readyState === 'complete' || document.readyState !== 'loading') {
        init_func();
     } else {
        document.addEventListener('DOMContentLoaded', init_func);
      }

</script>


{% endblock %}
